name: Docs CI/CD

on:
  push:
    branches: ["main"]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

env:
  INSTANCE: "Writerside/hi"
  DOCKER_VERSION: "2025.04.8412"

jobs:
  docs:
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Resolve artifact names
        id: artifact
        run: |
          INSTANCE=${INSTANCE#*/}
          INSTANCE_ID_UPPER=$(echo "$INSTANCE" | tr '[:lower:]' '[:upper:]')
          echo "artifact=webHelp${INSTANCE_ID_UPPER}2-all.zip" >> "$GITHUB_OUTPUT"

      - name: Inject Pages and Algolia frontend config
        env:
          ALGOLIA_APP_NAME: ${{ vars.ALGOLIA_APP_NAME }}
          ALGOLIA_INDEX_NAME: ${{ vars.ALGOLIA_INDEX_NAME }}
          ALGOLIA_SEARCH_ONLY_KEY_VAR: ${{ vars.ALGOLIA_SEARCH_ONLY_KEY }}
          ALGOLIA_SEARCH_ONLY_KEY_SECRET: ${{ secrets.ALGOLIA_SEARCH_ONLY_KEY }}
        run: |
          FILE="Writerside/cfg/buildprofiles.xml"

          OWNER="${GITHUB_REPOSITORY_OWNER}"
          REPO="${GITHUB_REPOSITORY#*/}"
          if [ "${REPO}" = "${OWNER}.github.io" ]; then
            PAGES_URL="https://${OWNER}.github.io"
          else
            PAGES_URL="https://${OWNER}.github.io/${REPO}"
          fi

          sed -i "s#<web-root>.*</web-root>#<web-root>${PAGES_URL}</web-root>#" "$FILE"
          sed -i "s#<product-web-url>.*</product-web-url>#<product-web-url>${PAGES_URL}</product-web-url>#" "$FILE"

          ALGOLIA_SEARCH_ONLY_KEY="${ALGOLIA_SEARCH_ONLY_KEY_VAR}"
          if [ -z "${ALGOLIA_SEARCH_ONLY_KEY}" ]; then
            ALGOLIA_SEARCH_ONLY_KEY="${ALGOLIA_SEARCH_ONLY_KEY_SECRET}"
          fi

          sed -i '/<algolia-id>.*<\/algolia-id>/d' "$FILE"
          sed -i '/<algolia-index>.*<\/algolia-index>/d' "$FILE"
          sed -i '/<algolia-api-key>.*<\/algolia-api-key>/d' "$FILE"
          sed -i '/<algolia-show-logo>.*<\/algolia-show-logo>/d' "$FILE"

          if [ -n "${ALGOLIA_APP_NAME}" ] && [ -n "${ALGOLIA_INDEX_NAME}" ] && [ -n "${ALGOLIA_SEARCH_ONLY_KEY}" ]; then
            if ! grep -q '<noindex-content>false</noindex-content>' "$FILE"; then
              sed -i '/<build-profile instance="hi">/a\
                <noindex-content>false</noindex-content>' "$FILE"
            fi

            sed -i "/<noindex-content>false<\\/noindex-content>/a\\
                <algolia-id>${ALGOLIA_APP_NAME}</algolia-id>\\
                <algolia-index>${ALGOLIA_INDEX_NAME}</algolia-index>\\
                <algolia-api-key>${ALGOLIA_SEARCH_ONLY_KEY}</algolia-api-key>\\
                <algolia-show-logo>true</algolia-show-logo>" "$FILE"

            if grep -q '<algolia-id>' "$FILE"; then
              echo "Algolia frontend config injected into buildprofiles.xml"
            else
              echo "Failed to inject Algolia frontend config" >&2
              exit 1
            fi
          else
            echo "Algolia frontend config is incomplete. Built-in search will be used."
          fi

      - name: Build documentation
        uses: JetBrains/writerside-github-action@v4
        with:
          instance: ${{ env.INSTANCE }}
          docker-version: ${{ env.DOCKER_VERSION }}

      - name: Run Writerside checks
        uses: JetBrains/writerside-checker-action@v1
        with:
          instance: ${{ env.INSTANCE }}

      - name: Unzip static site
        run: unzip -O UTF-8 -qq "artifacts/${{ steps.artifact.outputs.artifact }}" -d site

      - name: Publish offline package
        run: |
          mkdir -p site/downloads
          cp "artifacts/${{ steps.artifact.outputs.artifact }}" site/downloads/offline-docs.zip

      - name: Setup Pages
        uses: actions/configure-pages@v5

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: site

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
