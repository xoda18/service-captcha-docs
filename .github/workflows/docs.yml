name: Docs CI/CD

on:
  push:
    branches: ["main"]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

env:
  INSTANCE: "Writerside/hi"
  DOCKER_VERSION: "2025.04.8412"

jobs:
  build:
    runs-on: ubuntu-latest
    outputs:
      artifact: ${{ steps.artifact.outputs.artifact }}
      algolia_artifact: ${{ steps.artifact.outputs.algolia_artifact }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Resolve artifact names
        id: artifact
        run: |
          INSTANCE=${INSTANCE#*/}
          INSTANCE_ID_UPPER=$(echo "$INSTANCE" | tr '[:lower:]' '[:upper:]')
          echo "artifact=webHelp${INSTANCE_ID_UPPER}2-all.zip" >> "$GITHUB_OUTPUT"
          echo "algolia_artifact=algolia-indexes-${INSTANCE_ID_UPPER}.zip" >> "$GITHUB_OUTPUT"

      - name: Build documentation
        uses: JetBrains/writerside-github-action@v4
        with:
          instance: ${{ env.INSTANCE }}
          docker-version: ${{ env.DOCKER_VERSION }}

      - name: Upload documentation artifacts
        uses: actions/upload-artifact@v4
        with:
          name: docs
          path: |
            artifacts/${{ steps.artifact.outputs.artifact }}
            artifacts/${{ steps.artifact.outputs.algolia_artifact }}
            artifacts/report.json
          retention-days: 7

  test:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Download documentation artifacts
        uses: actions/download-artifact@v4
        with:
          name: docs
          path: artifacts

      - name: Run Writerside checks
        uses: JetBrains/writerside-checker-action@v1
        with:
          instance: ${{ env.INSTANCE }}

  deploy:
    runs-on: ubuntu-latest
    needs: [build, test]
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Download documentation artifacts
        uses: actions/download-artifact@v4
        with:
          name: docs
          path: artifacts

      - name: Unzip static site
        run: unzip -O UTF-8 -qq "artifacts/${{ needs.build.outputs.artifact }}" -d site

      - name: Publish offline package
        run: |
          mkdir -p site/downloads
          cp "artifacts/${{ needs.build.outputs.artifact }}" site/downloads/offline-docs.zip

      - name: Setup Pages
        uses: actions/configure-pages@v5

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: site

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

  publish-indexes:
    runs-on: ubuntu-latest
    needs: [build, test]
    if: ${{ vars.ALGOLIA_APP_NAME != '' && vars.ALGOLIA_INDEX_NAME != '' && vars.CONFIG_JSON_PRODUCT != '' && vars.CONFIG_JSON_VERSION != '' }}
    container:
      image: registry.jetbrains.team/p/writerside/builder/algolia-publisher:2.0.32-3
    env:
      ALGOLIA_APP_NAME: ${{ vars.ALGOLIA_APP_NAME }}
      ALGOLIA_INDEX_NAME: ${{ vars.ALGOLIA_INDEX_NAME }}
      CONFIG_JSON_PRODUCT: ${{ vars.CONFIG_JSON_PRODUCT }}
      CONFIG_JSON_VERSION: ${{ vars.CONFIG_JSON_VERSION }}
      ALGOLIA_KEY: ${{ secrets.ALGOLIA_KEY }}
    steps:
      - name: Guard missing Algolia secret
        id: guard
        run: |
          if [ -z "${ALGOLIA_KEY}" ]; then
            echo "ALGOLIA_KEY is empty. Skipping Algolia publish."
            echo "should_publish=false" >> "$GITHUB_OUTPUT"
          else
            echo "should_publish=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Download documentation artifacts
        if: steps.guard.outputs.should_publish == 'true'
        uses: actions/download-artifact@v4
        with:
          name: docs
          path: artifacts

      - name: Unpack Algolia records
        if: steps.guard.outputs.should_publish == 'true'
        run: |
          mkdir -p algolia-index
          unzip -O UTF-8 -qq "artifacts/${{ needs.build.outputs.algolia_artifact }}" -d algolia-index

      - name: Publish Algolia index
        if: steps.guard.outputs.should_publish == 'true'
        run: |
          env "algolia-key=${ALGOLIA_KEY}" java -jar /opt/builder/help-publication-agent.jar \
            update-index \
            --application-name "${ALGOLIA_APP_NAME}" \
            --index-name "${ALGOLIA_INDEX_NAME}" \
            --product "${CONFIG_JSON_PRODUCT}" \
            --version "${CONFIG_JSON_VERSION}" \
            --index-directory algolia-index/ \
            2>&1 | tee algolia-update-index-log.txt

      - name: Upload Algolia publish log
        if: steps.guard.outputs.should_publish == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: algolia-publish-log
          path: algolia-update-index-log.txt
          retention-days: 7
